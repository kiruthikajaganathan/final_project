<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Student Details</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 sidebar">
                <div class="logo">
                    <img src="/images/logo3.png" alt="College Logo" style="max-width: 100px;">
                    <br>
                    <img src="/images/logo2.jpeg.png" alt="College Logo" style="max-width: 200px;">
                </div>
                <div class="college-address">
                    Nehru Nagar,Civil Aerodrome Post, <br> Coimbatore - 641014
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#" id="dashboardLink">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="allStudentsLink">All Students Details</a></li>
                    <li class="nav-item">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Export
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">Export to Excel</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToCSV()">Export to CSV</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="col-md-9 main-content">
                <div class="add-student-button"> 
                    <a href="/student.html" class="btn btn-success">Add Student</a>
                </div>
                <div id="dashboardContent" style="display: none;"></div>
                <div id="studentDetailsContent">
                    <h1>Admin - Student Details</h1>
                    <div class="search-bar">
                        <input type="text" id="searchBar" placeholder="Search students..." onkeyup="searchTable()">
                    </div>
                    <div class="filter-bar">
                        <select id="filterCategory">
                            <option value="">Select Category</option>
                            <option value="year">Year</option>
                            <option value="department">Department</option>
                            <option value="community">Community</option>
                            <option value="hostel">Hostel/Day Scholar</option>
                            <option value="regular">Regular/Lateral</option>
                            <option value="bloodGroup">Blood Group</option>
                            <option value="batch">Batch</option>
                            <option value="first">First Graduate</option>
                        </select>
                        <select id="filterValue">
                            <option value="">Select Value</option>
                        </select>
                        <button id="filterButton">Filter</button>
                        <button id="resetButton">Back</button>
                    </div>
                    <div class="table-container">
                        <table id="studentTable">
                            <thead>
                                <tr>
                                    <th>S.NO</th>
                                    <th>Register No</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="studentDetailsModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this student?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let filterCategory = "";
        let filterValue = "";
        let studentsData = "";

        function filterStudents() {
            filterCategory = document.getElementById("filterCategory").value;
            filterValue = document.getElementById("filterValue").value;
            renderTable();
        }

        function resetFilters() {
            filterCategory = "";
            filterValue = "";
            document.getElementById("filterCategory").value = "";
            document.getElementById("filterValue").innerHTML = '<option value="">Select Value</option>';
            renderTable();
        }

        function renderTable() {
            let filteredStudents = studentsData.slice();

            if (filterCategory && filterValue) {
                filteredStudents = filteredStudents.filter(student => {
                    if (filterCategory === "hostel") return student.hostel === filterValue;
                    if (filterCategory === "regular") return student.regular === filterValue;
                    if (filterCategory === "bloodGroup") return student.bloodGroup === filterValue;
                    if (filterCategory === "department") return student.department === filterValue;
                    if (filterCategory === "community") return student.community === filterValue;
                    if (filterCategory === "batch") return student.batch.split('-')[0] === filterValue;
                    if (filterCategory === "year") return student.year === filterValue;
                    if (filterCategory === "first") return student.first === filterValue;
                    return true;
                });
            }

            filteredStudents.sort((a, b) => {
                const departmentComparison = a.department.localeCompare(b.department);
                if (departmentComparison === 0) {
                    return a.name.localeCompare(b.name);
                }
                return departmentComparison;
            });

            const tableBody = document.getElementById("studentTableBody");
            tableBody.innerHTML = "";

            filteredStudents.forEach((student, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
    <td>${index + 1}</td>
    <td>${student.registerNo}</td>
    <td class="align-left">${student.name}</td> 
    <td>${student.department}</td>
    <td class="actions-cell">
        <button class="btn btn-primary btn-sm view-btn" data-bs-toggle="modal" data-bs-target="#studentDetailsModal" onclick="viewStudentDetails('${student.registerNo}')">View</button>
        <button class="btn btn-danger btn-sm delete-btn" data-register-no="${student.registerNo}">Delete</button>
    </td>
`;
                tableBody.appendChild(row);
            });

            // Add event listeners to delete buttons after they are added to the DOM
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const registerNo = this.dataset.registerNo;
                    const row = this.closest('tr'); 

                    // Show the modal
                    const deleteModal = document.getElementById('confirmDeleteModal');
                    deleteModal.dataset.registerNo = registerNo;
                    deleteModal.dataset.row = row; 

                    const modal = new bootstrap.Modal(deleteModal);
                    modal.show();
                });
            });
        }

        function searchTable() {
            searchText = document.getElementById("searchBar").value.toLowerCase();
            let table = document.getElementById("studentTable");
            let rows = table.getElementsByTagName("tr");

            for (let i = 1; i < rows.length; i++) {
                let name = rows[i].getElementsByTagName("td")[2]?.textContent.toLowerCase();
                let registerNo = rows[i].getElementsByTagName("td")[1]?.textContent.toLowerCase();

                if (name.includes(searchText) || registerNo.includes(searchText)) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }

        function displayDashboard() {
            const dashboardContent = document.getElementById("dashboardContent");
            dashboardContent.style.display = "block";
            document.getElementById("studentDetailsContent").style.display = "none";

            let totalStudents = studentsData.length;
            let departmentCounts = {};

            studentsData.forEach(student => {
                departmentCounts[student.department] = (departmentCounts[student.department] || 0) + 1;
            });

            let dashboardHTML = `
                <div class="dashboard-grid">
                    <div class="dashboard-item">
                        <h2>Total No Of Students Submitted</h2>
                        <p>${totalStudents}</p>
                    </div>
            `;

            for (const department in departmentCounts) {
                dashboardHTML += `
                    <div class="dashboard-item">
                        <h2>${department}</h2>
                        <p>${departmentCounts[department]}</p>
                    </div>
                `;
            }

            dashboardHTML += `</div>`;
            dashboardContent.innerHTML = dashboardHTML;
        }

        function displayAllStudents() {
            document.getElementById("dashboardContent").style.display = "none";
            document.getElementById("studentDetailsContent").style.display = "block";
        }

        function loadStudents() {
            console.log("loadStudents() called");
            fetch("/students")
                .then(response => response.json())
                .then(data => {
                    console.log("Data received:", data);
                    studentsData = data;
                    renderTable();
                    populateFilterValues();
                    displayAllStudents();
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                });
        }

        function populateFilterValues() {
            const filterCategorySelect = document.getElementById("filterCategory");
            const filterValueSelect = document.getElementById("filterValue");
            filterValueSelect.innerHTML = '<option value="">Select Value</option>';

            if (filterCategorySelect.value) {
                const category = filterCategorySelect.value;
                const uniqueValues = new Set();
                studentsData.forEach(student => {
                    let value;
                    if (category === "hostel") value = student.hostel;
                    if (category === "regular") value = student.regular;
                    if (category === "bloodGroup") value = student.bloodGroup;
                    if (category === "department") value = student.department;
                    if (category === "community") value = student.community;
                    if (category === "batch") value = student.batch;
                    if (category === "year") value = student.year;
                    if (value) uniqueValues.add(value);
                });
                uniqueValues.forEach(value => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = value;
                    filterValueSelect.appendChild(option);
                });
            }
        }

        function viewStudentDetails(registerNo) {
            const student = studentsData.find(s => s.registerNo === registerNo);
            const modalBody = document.getElementById("studentDetailsModalBody");
            modalBody.innerHTML = "";

            if (student) {
                const detailsTable = document.createElement("table");
                detailsTable.classList.add("table");
                let tableContent = `
                    <tr><th>Register No:</th><td>${student.registerNo}</td></tr>
                    <tr><th>Name:</th><td>${student.name}</td></tr>
                    <tr><th>Department:</th><td>${student.department}</td></tr>
                    <tr><th>DOB:</th><td>${new Date(student.dob).toLocaleDateString()}</td></tr>
                    <tr><th>Gender:</th><td>${student.gender}</td></tr>
                    <tr><th>Batch:</th><td>${student.batch}</td></tr>
                    <tr><th>Blood Group:</th><td>${student.bloodGroup}</td></tr>
                    <tr><th>Mobile:</th><td>${student.mobileNo}</td></tr>
                    <tr><th>Email:</th><td>${student.email}</td></tr>
                    <tr><th>Nationality:</th><td>${student.nationality}</td></tr>
                    <tr><th>Religion:</th><td>${student.religion}</td></tr>
                    <tr><th>Community:</th><td>${student.community}</td></tr>
                    <tr><th>Mother Tongue:</th><td>${student.motherTongue}</td></tr>
                    <tr><th>Aadhaar:</th><td>${student.aadharNo}</td></tr>
                    <tr><th>Year:</th><td>${student.year}</td></tr>
                    <tr><th>First Graduate:</th><td>${student.first}</td></tr>
                    <tr><th>Address:</th><td>${student.address.doorNo}, ${student.address.street}, ${student.address.villageCity}, ${student.address.state}, ${student.address.district}, ${student.address.pinCode}</td></tr>
                    <tr><th>Father Name:</th><td>${student.parents.father.name}</td></tr>
                    <tr><th>Father Occupation:</th><td>${student.parents.father.occupation}</td></tr>
                    <tr><th>Father Mobile:</th><td>${student.parents.father.mobile}</td></tr>
                    <tr><th>Mother Name:</th><td>${student.parents.mother.name}</td></tr>
                    <tr><th>Mother Occupation:</th><td>${student.parents.mother.occupation}</td></tr>
                    <tr><th>Mother Mobile:</th><td>${student.parents.mother.mobile}</td></tr>
                    <tr><th>10th School Name:</th><td>${student.schoolDetails.find(s => s.classLevel === "X")?.name || 'N/A'}</td></tr>
                    <tr><th>10th Marks:</th><td>${student.schoolDetails.find(s => s.classLevel === "X")?.marks || 'N/A'}</td></tr>
                    <tr><th>10th Year:</th><td>${student.schoolDetails.find(s => s.classLevel === "X")?.passingYear || 'N/A'}</td></tr>
                    <tr><th>11th School Name:</th><td>${student.schoolDetails.find(s => s.classLevel === "XI")?.name || 'N/A'}</td></tr>
                    <tr><th>11th Marks:</th><td>${student.schoolDetails.find(s => s.classLevel === "XI")?.marks || 'N/A'}</td></tr>
                    <tr><th>11th Year:</th><td>${student.schoolDetails.find(s => s.classLevel === "XI")?.passingYear || 'N/A'}</td></tr>
                    <tr><th>12th School Name:</th><td>${student.schoolDetails.find(s => s.classLevel === "XII")?.name || 'N/A'}</td></tr>
                    <tr><th>12th Marks:</th><td>${student.schoolDetails.find(s => s.classLevel === "XII")?.marks || 'N/A'}</td></tr>
                    <tr><th>12th Year:</th><td>${student.schoolDetails.find(s => s.classLevel === "XII")?.passingYear || 'N/A'}</td></tr>
                    <tr><th>Cutoff:</th><td>${student.cutoff}</td></tr>
                    <tr><th>Aadhaar Card:</th><td><a href="${student.documents?.aadharCard || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Community Certificate:</th><td><a href="${student.documents?.communityCertificate || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Marksheet 10:</th><td><a href="${student.documents?.tenthMarkSheet || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Marksheet 11:</th><td><a href="${student.documents?.eleventhMarkSheet || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Marksheet 12:</th><td><a href="${student.documents?.twelfthMarkSheet || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Transfer Certificate:</th><td><a href="${student.documents?.transferCertificate || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Birth Certificate:</th><td><a href="${student.documents?.birthCertificate || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>First Graduate Certificate:</th><td><a href="${student.documents?.firstCertificate || '#'}" target="_blank">View</a></td></tr>
                    <tr><th>Photo:</th><td><a href="#" onclick="openPhotoModal('${student.documents?.photo || '#'}')">View</a></td></tr>
                `;
                detailsTable.innerHTML = tableContent;
                modalBody.appendChild(detailsTable);
            } else {
                modalBody.textContent = "Student not found!";
            }
        }

        function openPhotoModal(photoUrl) {
            if (!photoUrl || photoUrl === "#") {
                alert("No photo available!");
                return;
            }
            window.open(photoUrl, '_blank');
        }

        loadStudents();

        document.getElementById("filterCategory").addEventListener("change", populateFilterValues);
        document.getElementById("filterButton").addEventListener("click", filterStudents);
        document.getElementById("resetButton").addEventListener("click", resetFilters);

        document.getElementById("dashboardLink").addEventListener("click", function (event) {
            event.preventDefault();
            displayDashboard();
        });

        document.getElementById("allStudentsLink").addEventListener("click", function (event) {
            event.preventDefault();
            displayAllStudents();
        });

        function exportToExcel() {
            const table = document.getElementById('studentTable');

            const ws = XLSX.utils.table_to_sheet(table, {
                raw: true 
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Student Details');
            XLSX.writeFile(wb, 'student_details.xlsx');
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const table = document.getElementById('studentTable');
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData =[]; 
                const cols = row.querySelectorAll('th, td');
                cols.forEach(col => rowData.push(col.innerText));
                csvContent += rowData.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_details.csv");
            document.body.appendChild(link);
            link.click();
        }

        // Event listener for the modal delete button
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        confirmDeleteButton.addEventListener('click', function() {
            const deleteModal = document.getElementById('confirmDeleteModal');
            const registerNo = deleteModal.dataset.registerNo;
            const row = deleteModal.dataset.row; 

            fetch(`/api/students/${registerNo}`, { method: "DELETE" })
                .then(response => response.json())
                .then(() => {
                    alert("Deleted successfully!");
                    const rowElement = document.querySelector(`[data-register-no="${registerNo}"]`).closest('tr');
                    rowElement.remove();
                    
                    const modal = bootstrap.Modal.getInstance(deleteModal);
                    modal.hide();
                })
                .catch(error => console.error("Delete error:", error));
        });
    </script>
</body>
</html>