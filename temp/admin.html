<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Student Details</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 sidebar">
                <div class="logo">
                    <img src="/images/logo3.png" alt="College Logo" style="max-width: 100px;">
                    <br>
                    <img src="/images/logo2.jpeg.png" alt="College Logo" style="max-width: 200px;">
                </div>
                <div class="college-address">
                    Nehru Nagar,Civil Aerodrome Post, <br> Coimbatore - 641014
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#" id="dashboardLink">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="allStudentsLink">All Students Details</a></li>
                    <li class="nav-item"><a class="nav-link" href="/student.html">Add Students</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="seatsAllocationLink">Seat Allocation</a></li> 
                    <li class="nav-item"><a class="nav-link" href="#" id="feesStructureLink">Fees Structure</a></li>
                    <li class="nav-item">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Export
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">Export to Excel</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToCSV()">Export to CSV</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="col-md-9 main-content">
                <div id="dashboardContent"></div>
                <div id="studentDetailsContent" style="display: none;">
                    <h1>Admin - Student Details</h1>
                    <div class="search-bar">
                        <input type="text" id="searchBar" placeholder="Search students..." onkeyup="searchTable()">
                    </div>
                    <div class="filter-bar">
                        <select id="filterCategory">
                            <option value="">Select Category</option>
                            <option value="year">Year</option>
                            <option value="department">Department</option>
                            <option value="community">Community</option>
                            <option value="hostel">Hostel/Day Scholar</option>
                            <option value="regular">Regular/Lateral</option>
                            <option value="bloodGroup">Blood Group</option>
                            <option value="batch">Batch</option>
                            <option value="first">First Graduate</option>
                        </select>
                        <select id="filterValue">
                            <option value="">Select Value</option>
                        </select>
                        <button id="filterButton">Filter</button>
                        <button id="resetButton">Back</button>
                    </div>
                    <div class="table-container">
                        <table id="studentTable">
                            <thead>
                                <tr>
                                    <th>S.NO</th>
                                    <th>Application No</th>
                                    <th>Register No</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="seatsAllocationContent" style="display: none;">
                    <h1>Seat Allocation</h1>
                    <div id="seatsAllocationTable"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="studentDetailsModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this student?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="missingFieldsModal" tabindex="-1" aria-labelledby="missingFieldsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="missingFieldsModalLabel">Missing Fields</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="missingFieldsList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let filterCategory = "";
        let filterValue = "";
        let searchText = "";
        let studentsData = "";
        let currentAdmissionStatusFilter = null;
        let editingStudent = null; // Add this line

        function filterStudents() {
            filterCategory = document.getElementById("filterCategory").value;
            filterValue = document.getElementById("filterValue").value;
            renderTable();
        }

        function resetFilters() {
            filterCategory = "";
            filterValue= "";
            document.getElementById("filterCategory").value = "";
            document.getElementById("filterValue").innerHTML = '<option value="">Select Value</option>';
            currentAdmissionStatusFilter = null; // Reset admission status filter
            renderTable();
        }

        function renderTable() {
            let filteredStudents = studentsData.slice();

            // Apply admission status filter if it's set
            if (currentAdmissionStatusFilter) {
                filteredStudents = filteredStudents.filter(student => {
                    return student.admissionStatus && student.admissionStatus.status === currentAdmissionStatusFilter;
                });
            }

            // Apply category and value filter
            if (filterCategory && filterValue) {
                filteredStudents = filteredStudents.filter(student => {
                    if (filterCategory === "hostel") return student.hostel === filterValue;
                    if (filterCategory === "regular") return student.regular === filterValue;
                    if (filterCategory === "bloodGroup") return student.bloodGroup === filterValue;
                    if (filterCategory === "department") return student.department === filterValue;
                    if (filterCategory === "community") return student.community === filterValue;
                    if (filterCategory === "batch") return student.batch.split('-')[0] === filterValue;
                    if (filterCategory === "year") return student.year === filterValue;
                    if (filterCategory === "first") return student.first === filterValue;
                    return true;
                });
            }

            // Apply search filter
            if (searchText) {
                filteredStudents = filteredStudents.filter(student => {
                    return (
                        student.name.toLowerCase().includes(searchText) ||
                        student.registerNo.toLowerCase().includes(searchText) ||
                        student.applicationNo.toLowerCase().includes(searchText)
                    );
                });
            }

            filteredStudents.sort((a, b) => {
                const departmentComparison = a.department.localeCompare(b.department);
                if (departmentComparison === 0) {
                    return a.name.localeCompare(b.name);
                }
                return departmentComparison;
            });

            const tableBody = document.getElementById("studentTableBody");
            tableBody.innerHTML = "";

            filteredStudents.forEach((student, index) => {
                const row = document.createElement("tr");

                let statusText = student.admissionStatus.status;
                let missingFieldsParam = "";
                let statusDisplay = "";

                if (student.missingFields && student.missingFields.length > 0 && statusText === 'Pending') {
                    missingFieldsParam = encodeURIComponent(JSON.stringify(student.missingFields));
                    statusDisplay = `<a href="#" onclick="showMissingFieldsModal('${missingFieldsParam}')">${statusText}</a>`;
                } else if (student.missingFields && student.missingFields.length === 0) {
                    statusDisplay = '<span style="color: green;">Completed</span>';
                } else {
                    statusDisplay = statusText; // Display the original status without a link
                }
                row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.applicationNo}</td>
                <td>${student.registerNo}</td>
                <td class="align-left">${student.name}</td>
                <td>${student.department}</td>
                <td>${statusDisplay}</td>
                <td class="actions-cell">
                    <button class="btn btn-primary btn-sm view-btn" data-bs-toggle="modal" data-bs-target="#studentDetailsModal" onclick="viewStudentDetails('${student.registerNo}')">View</button>
                    <button class="btn btn-danger btn-sm delete-btn" data-register-no="${student.registerNo}">Delete</button>
                </td>
            `;
                tableBody.appendChild(row);
            });
            

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const registerNo = this.dataset.registerNo;
                    const row = this.closest('tr');  
                    const deleteModal = document.getElementById('confirmDeleteModal');
                    deleteModal.dataset.registerNo = registerNo;
                    deleteModal.dataset.row = row;   
                    const modal = new bootstrap.Modal(deleteModal);
                    modal.show();
                });
            });
        }

        function showMissingFieldsModal(missingFieldsParam) {
            if (missingFieldsParam) {
                const missingFields = JSON.parse(decodeURIComponent(missingFieldsParam));
                const list = document.getElementById('missingFieldsList');
                list.innerHTML = '';
                const ul = document.createElement('ul');
                missingFields.forEach(field => {
                    const li = document.createElement('li');
                    li.textContent = field;
                    ul.appendChild(li);
                });
                list.appendChild(ul);
                const missingFieldsModal = new bootstrap.Modal(document.getElementById("missingFieldsModal"));
                missingFieldsModal.show();
            }
        }

        function searchTable() {
            searchText = document.getElementById("searchBar").value.toLowerCase();
            let table = document.getElementById("studentTable");
            let rows = table.getElementsByTagName("tr");
            for (let i = 1; i < rows.length; i++) {
                let name = rows[i].getElementsByTagName("td")[3]?.textContent?.toLowerCase() || "";
                let registerNo = rows[i].getElementsByTagName("td")[2]?.textContent?.toLowerCase() || "";
                let applicationNo = rows[i].getElementsByTagName("td")[1]?.textContent?.toLowerCase() || "";
                if (name.includes(searchText) || registerNo.includes(searchText) || applicationNo.includes(searchText)) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
function displayDashboard() {
    const dashboardContent = document.getElementById("dashboardContent");
    dashboardContent.style.display = "block";
    document.getElementById("studentDetailsContent").style.display = "none";
    document.getElementById("seatsAllocationContent").style.display = "none";

    let totalStudents = studentsData.length;
    let statusCounts = {
        "Admitted": 0,
        "Pending": 0,
        "Not Admitted": 0
    };
    let departmentCounts = {};

    console.log("Students Data for Dashboard:", studentsData);

    studentsData.forEach(student => {
        console.log("Processing student:", student);

        if (student.admissionStatus && student.admissionStatus.status) {
            let status = student.admissionStatus.status.trim().toUpperCase();

            switch (status) {
                case "ADMITTED":
                    statusCounts["Admitted"]++;
                    console.log("  Count updated (Admitted):", statusCounts);
                    break;
                case "PENDING":
                    statusCounts["Pending"]++;
                    console.log("  Count updated (Pending):", statusCounts);
                    break;
                case "NOT ADMITTED":
                    statusCounts["Not Admitted"]++;
                    console.log("  Count updated (Not Admitted):", statusCounts);
                    break;
                default:
                    console.warn("  Unknown admission status:", status);
            }
        } else {
            console.warn("  Student missing admissionStatus or status:", student);
        }

        if (student.department) {
            departmentCounts[student.department] = (departmentCounts[student.department] || 0) + 1;
        } else {
            console.warn("  Student missing department:", student);
        }
    });

    console.log("Final Status Counts:", statusCounts);
    console.log("Final Department Counts:", departmentCounts);

    let dashboardHTML = `
        <div class="dashboard-grid admission-status-grid">
            <div class="dashboard-item">
                <h2>Total Students</h2>
                <p>${totalStudents}</p>
            </div>
            <div class="dashboard-item">
                <h2>Admitted</h2>
                <p><a href="#" onclick="showStudentsByStatus('Admitted')">${statusCounts["Admitted"]}</a></p>
            </div>
            <div class="dashboard-item">
                <h2>Pending</h2>
                <p><a href="#" onclick="showStudentsByStatus('Pending')">${statusCounts["Pending"]}</a></p>
            </div>
            <div class="dashboard-item">
                <h2>Not Admitted</h2>
                <p><a href="#" onclick="showStudentsByStatus('Not Admitted')">${statusCounts["Not Admitted"]}</a></p>
            </div>
        </div>

        <div class="dashboard-grid department-grid">
    `;

    for (const department in departmentCounts) {
        dashboardHTML += `
            <div class="dashboard-item">
                <h2>${department}</h2>
                <p>${departmentCounts[department]}</p>
            </div>
        `;
    }

    dashboardHTML += `</div>`;
    dashboardContent.innerHTML = dashboardHTML;
}
        function displayAllStudents() {
            document.getElementById("dashboardContent").style.display = "none";
            document.getElementById("studentDetailsContent").style.display = "block";
            document.getElementById("seatsAllocationContent").style.display = "none";
            currentAdmissionStatusFilter = null; // Reset admission status filter
            renderTable();
        }

        function loadStudents() {
            console.log("loadStudents() called");
            fetch("/students")
                .then(response => response.json())
                .then(data => {
                    console.log("Data received:", data);
                    studentsData = data;
                    renderTable();
                    populateFilterValues();
                    displayDashboard();
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                });
        }

        

        function populateFilterValues() {
            const filterCategorySelect = document.getElementById("filterCategory");
            const filterValueSelect = document.getElementById("filterValue");filterValueSelect.innerHTML = '<option value="">Select Value</option>';
            if (filterCategorySelect.value) {
                const category = filterCategorySelect.value;
                const uniqueValues = new Set();
                studentsData.forEach(student => {
                    let value;
                    if (category === "hostel") value = student.hostel;
                    if (category === "regular") value = student.regular;
                    if (category === "bloodGroup") value = student.bloodGroup;
                    if (category === "department") value = student.department;
                    if (category === "community") value = student.community;
                    if (category === "batch") value = student.batch;
                    if (category === "year") value = student.year;
                    if (value) uniqueValues.add(value);
                });
                uniqueValues.forEach(value => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = value;
                    filterValueSelect.appendChild(option);
                });
            }
        }

        function viewStudentDetails(registerNo) {
            const student = studentsData.find(s => s.registerNo === registerNo);
            const modalBody = document.getElementById("studentDetailsModalBody");
            modalBody.innerHTML = "";

            if (!student) {
                modalBody.textContent = "Student not found!";
                return;
            }
                const detailsContent = `
                <div class="student-view-container">
                    <!-- Header Section -->
                    <div class="student-header bg-primary text-white p-4 rounded-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1">${student.name || "N/A"}</h2>
                                <p class="mb-0">Register No: ${student.registerNo || "N/A"}</p>
                                <p class="mb-0">${student.department || "N/A"} - Batch ${student.batch || "N/A"}</p>
                            </div>
                            <div class="student-photo">
                                <img src="${student.documents?.photo || 'placeholder.jpg'}" 
                                     class="img-thumbnail" 
                                     style="width: 150px; height: 200px; object-fit: cover;"
                                     onerror="this.src='placeholder.jpg'">
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                                    <div class="card-body">
                                        <dl class="row">
                                            <dt class="col-sm-5">Date of Birth</dt>
                                            <dd class="col-sm-7">${student.dob ? new Date(student.dob).toLocaleDateString() : "N/A"}</dd>

                                            <dt class="col-sm-5">Gender</dt>
                                            <dd class="col-sm-7">${student.gender || "N/A"}</dd>

                                            <dt class="col-sm-5">Blood Group</dt>
                                            <dd class="col-sm-7">${student.bloodGroup || "N/A"}</dd>

                                            <dt class="col-sm-5">Aadhaar No</dt>
                                            <dd class="col-sm-7">${student.aadharNo || "N/A"}</dd>

                                            <dt class="col-sm-5">Mobile</dt>
                                            <dd class="col-sm-7">${student.mobileNo || "N/A"}</dd>

                                            <dt class="col-sm-5">Email</dt>
                                            <dd class="col-sm-7">${student.email || "N/A"}</dd>
                                            <dt class="col-sm-5">Nationality</dt>
                                            <dd class="col-sm-7">${student.nationality || "N/A"}</dd>

                                            <dt class="col-sm-5">Religion</dt>
                                            <dd class="col-sm-7">${student.religion || "N/A"}</dd>

                                            <dt class="col-sm-5">Community</dt>
                                            <dd class="col-sm-7">${student.community || "N/A"}</dd>

                                            <dt class="col-sm-5">Mother Tongue</dt>
                                            <dd class="col-sm-7">${student.motherTongue || "N/A"}</dd>

                                            <dt class="col-sm-5">First Graduate</dt>
                                            <dd class="col-sm-7">${student.first ? "Yes" : "No"}</dd>

                                            <dt class="col-sm-5">Admission Type</dt>
                                            <dd class="col-sm-7">${student.regular || "N/A"}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>

                           

                        <!-- Address Information -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Address Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p>${student.address.doorNo}, ${student.address.street}</p>
                                        <p>${student.address.villageCity}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p>${student.address.district}, ${student.address.state}</p>
                                        <p>PIN Code: ${student.address.pinCode}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parents Information -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Parents/Guardian Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Father's Details</h6>
                                        <p class="mb-1"><strong>Name:</strong> ${student.parents.father.name || "N/A"}</p>
                                        <p class="mb-1"><strong>Occupation:</strong> ${student.parents.father.occupation || "N/A"}</p>
                                        <p class="mb-0"><strong>Contact:</strong> ${student.parents.father.mobile || "N/A"}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Mother's Details</h6>
                                        <p class="mb-1"><strong>Name:</strong> ${student.parents.mother.name || "N/A"}</p>
                                        <p class="mb-1"><strong>Occupation:</strong> ${student.parents.mother.occupation || "N/A"}</p>
                                        <p class="mb-0"><strong>Contact:</strong> ${student.parents.mother.mobile || "N/A"}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Information -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Academic History</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${student.schoolDetails.map(school => `
                                        <div class="col-md-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6>Class ${school.classLevel}</h6>
                                                    <p class="mb-1"><strong>School:</strong> ${school.name || "N/A"}</p>
                                                    <p class="mb-1"><strong>Marks:</strong> ${school.marks || "N/A"}</p>
                                                    <p class="mb-0"><strong>Year:</strong> ${school.passingYear || "N/A"}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-3">
                                    <p class="mb-0"><strong>Cutoff Mark:</strong> ${student.cutoff || "N/A"}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Section -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Attached Documents</h5>
                            </div>
                            <div class="card-body">
                                <div class="row row-cols-1 row-cols-md-3 g-4">
                                    ${Object.entries(student.documents || {}).map(([docType, docPath]) => `
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-capitalize">
                                                        ${docType.replace(/([A-Z])/g, ' $1')}
                                                    </h6>
                                                    ${docPath ? `
                                                        <div class="d-flex flex-column gap-2">
                                                             <a href="${docPath.startsWith('/uploads/') ? docPath : '/uploads/' + docPath}" 
                                                            target="_blank" 
                                                            class="btn btn-outline-success btn-sm w-100">
                                                            View
                                                        </a>
                                    
                                                        <a href="${docPath.startsWith('/uploads/') ? docPath : '/uploads/' + docPath}" 
                                                            download 
                                                            class="btn btn-outline-primary btn-sm w-100">
                                                            Download
                                                        </a>
                                                </div>
                                            ` : '<span class="text-muted">Not Available</span>'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                    <div style="text-align: center;">
                        <button onclick="editStudentDetails('${student.registerNo}')" class="btn btn-warning px-5 align-item-center mt-3">
                            Edit Details
                        </button>
                    </div>
                        </div>
                    </div>
                </div>
            `;

            modalBody.innerHTML = detailsContent;
        }
        function openPhotoModal(photoUrl) {
            if (!photoUrl || photoUrl === "#") {
                alert("No photo available!");
                return;
            }
            window.open(photoUrl, '_blank');
        }

        loadStudents();
        document.getElementById("filterCategory").addEventListener("change", populateFilterValues);
        document.getElementById("filterButton").addEventListener("click", filterStudents);
        document.getElementById("resetButton").addEventListener("click", resetFilters);
        document.getElementById("dashboardLink").addEventListener("click", function (event) {
            event.preventDefault();
            displayDashboard();
        });
        document.getElementById("allStudentsLink").addEventListener("click", function (event) {
            event.preventDefault();
            displayAllStudents();
        });
        document.getElementById("seatsAllocationLink").addEventListener("click", function (event) {
    event.preventDefault();
    displaySeatsAllocation();
        });
    document.getElementById("feesStructureLink").addEventListener("click", function (event) {
    event.preventDefault();
    displayFeesStructure();
});


        function exportToExcel() {
            const table = document.getElementById('studentTable');
            const ws = XLSX.utils.table_to_sheet(table, {
                raw: true  
            });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Student Details');
            XLSX.writeFile(wb, 'student_details.xlsx');
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const table = document.getElementById('studentTable');
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData =[];  
                const cols = row.querySelectorAll('th, td');
                cols.forEach(col => rowData.push(col.innerText));
                csvContent += rowData.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_details.csv");
            document.body.appendChild(link);
            link.click();
        }

        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
confirmDeleteButton.addEventListener('click', function() {
    const deleteModal = document.getElementById('confirmDeleteModal');
    const registerNo = deleteModal.dataset.registerNo;

    fetch(`/api/students/${registerNo}`, { method: "DELETE" })
        .then(response => {
            if (!response.ok) {
                // Handle non-2xx HTTP responses
                return response.json().then(err => { throw new Error(err.error || 'Delete failed'); });
            }
            return response.json();
        })
        .then(() => {
            alert("Deleted successfully!");
            const rowElement = document.querySelector(`[data-register-no="${registerNo}"]`).closest('tr');
            rowElement.remove();
            const modal = bootstrap.Modal.getInstance(deleteModal);
            modal.hide();
        })
        .catch(error => {
            console.error("Delete error:", error);
            alert("Error deleting student: " + error.message); // Show user-friendly error
        });
});
    function displaySeatsAllocation() {
document.getElementById("dashboardContent").style.display = "none";
document.getElementById("studentDetailsContent").style.display = "none";
document.getElementById("seatsAllocationContent").style.display = "block";
fetch("/api/seats")
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Assuming the data from "/api/seats" now includes totalSeats,
        // managementQuotaSeats, and governmentQuotaSeats for each department
        renderSeatsAllocationTable(data);
    })
    .catch(error => {
        console.error("Error fetching seats allocation:", error);
        document.getElementById("seatsAllocationTable").innerHTML = `<p>Error loading seat allocation data. Please try again.</p>`;
    });
}
function renderSeatsAllocationTable(seatsData) {
    let tableHTML = `
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Total Seats</th>
                    <th>GQ Seats</th>
                    <th>MQ Seats</th>
                    <th>Government Quota (Filled)</th>
                    <th>Management Quota (Filled)</th>
                    <th>Government Quota (Pending)</th>
                    <th>Management Quota (Pending)</th>
                </tr>
            </thead>
            <tbody>
    `;
    seatsData.forEach(department => {
        tableHTML += `
            <tr>
                <td>${department.abbreviatedDepartment}</td>
                <td>${department.totalSeats}</td>
                <td>${department.governmentQuotaSeats}</td>
                <td>${department.managementQuotaSeats}</td>
                <td>${department.governmentQuota.filled}</td>
                <td>${department.managementQuota.filled}</td>
                <td>${department.governmentQuota.pending}</td>
                <td>${department.managementQuota.pending}</td>
            </tr>
        `;
    });
    tableHTML += `</tbody></table>`;
    document.getElementById("seatsAllocationTable").innerHTML = tableHTML;
}

    function showStudentsByStatus(status) {
        currentAdmissionStatusFilter = status; // Set the admission status filter
        displayAllStudents(); // Show the student details page
    }
    function editStudentDetails(registerNo) {
    editingStudent = studentsData.find(student => student.registerNo === registerNo);
    if (!editingStudent) {
        alert("Student not found!");
        return;
    }

    const modalBody = document.getElementById("studentDetailsModalBody");
    modalBody.innerHTML = `
       <form id="editStudentForm"  enctype="multipart/form-data">
    <div class="mb-3">
        <label for="editName" class="form-label">Name</label>
        <input type="text" class="form-control" id="editName" value="${editingStudent.name || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editDepartment" class="form-label">Department</label>
        <input type="text" class="form-control" id="editDepartment" value="${editingStudent.department || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editBatch" class="form-label">Batch</label>
        <input type="text" class="form-control" id="editBatch" value="${editingStudent.batch || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editDob" class="form-label">Date of Birth</label>
        <input type="date" class="form-control" id="editDob" value="${editingStudent.dob ? new Date(editingStudent.dob).toISOString().split('T')[0] : ''}" required>
    </div>
    <div class="mb-3">
        <label for="editGender" class="form-label">Gender</label>
        <input type="text" class="form-control" id="editGender" value="${editingStudent.gender || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editBloodGroup" class="form-label">Blood Group</label>
        <input type="text" class="form-control" id="editBloodGroup" value="${editingStudent.bloodGroup || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editAadharNo" class="form-label">Aadhaar No</label>
        <input type="text" class="form-control" id="editAadharNo" value="${editingStudent.aadharNo || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editMobileNo" class="form-label">Mobile</label>
        <input type="text" class="form-control" id="editMobileNo" value="${editingStudent.mobileNo || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editEmail" class="form-label">Email</label>
        <input type="email" class="form-control" id="editEmail" value="${editingStudent.email || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editNationality" class="form-label">Nationality</label>
        <input type="text" class="form-control" id="editNationality" value="${editingStudent.nationality || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editReligion" class="form-label">Religion</label>
        <input type="text" class="form-control" id="editReligion" value="${editingStudent.religion || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editCommunity" class="form-label">Community</label>
        <input type="text" class="form-control" id="editCommunity" value="${editingStudent.community || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editMotherTongue" class="form-label">Mother Tongue</label>
        <input type="text" class="form-control" id="editMotherTongue" value="${editingStudent.motherTongue || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editFirst" class="form-label">First Graduate</label>
        <select class="form-control" id="editFirst">
            <option value="true" ${editingStudent.first ? 'selected' : ''}>Yes</option>
            <option value="false" ${!editingStudent.first ? 'selected' : ''}>No</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="editRegular" class="form-label">Admission Type</label>
        <input type="text" class="form-control" id="editRegular" value="${editingStudent.regular || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editDoorNo" class="form-label">Door No</label>
        <input type="text" class="form-control" id="editDoorNo" value="${editingStudent.address.doorNo || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editStreet" class="form-label">Street</label>
        <input type="text" class="form-control" id="editStreet" value="${editingStudent.address.street || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editVillageCity" class="form-label">Village/City</label>
        <input type="text" class="form-control" id="editVillageCity" value="${editingStudent.address.villageCity || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editDistrict" class="form-label">District</label>
        <input type="text" class="form-control" id="editDistrict" value="${editingStudent.address.district || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editState" class="form-label">State</label>
        <input type="text" class="form-control" id="editState" value="${editingStudent.address.state || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editPinCode" class="form-label">PIN Code</label>
        <input type="text" class="form-control" id="editPinCode" value="${editingStudent.address.pinCode || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editFatherName" class="form-label">Father's Name</label>
        <input type="text" class="form-control" id="editFatherName" value="${editingStudent.parents.father.name || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editFatherOccupation" class="form-label">Father's Occupation</label>
        <input type="text" class="form-control" id="editFatherOccupation" value="${editingStudent.parents.father.occupation || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editFatherMobile" class="form-label">Father's Mobile</label>
        <input type="text" class="form-control" id="editFatherMobile" value="${editingStudent.parents.father.mobile || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editMotherName" class="form-label">Mother's Name</label>
        <input type="text" class="form-control" id="editMotherName" value="${editingStudent.parents.mother.name || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editMotherOccupation" class="form-label">Mother's Occupation</label>
        <input type="text" class="form-control" id="editMotherOccupation" value="${editingStudent.parents.mother.occupation || ''}" required>
    </div>
    <div class="mb-3">
        <label for="editMotherMobile" class="form-label">Mother's Mobile</label>
        <input type="text" class="form-control" id="editMotherMobile" value="${editingStudent.parents.mother.mobile || ''}" required>
    </div>

  ${editingStudent.schoolDetails.map((school, index) => `
        <div class="mb-3">
            <label for="editSchoolName${index}" class="form-label">School Name (Class ${school.classLevel})</label>
            <input type="text" class="form-control" id="editSchoolName${index}" value="${school.name || ''}" required>
        </div>
        <div class="mb-3">
            <label for="editSchoolMarks${index}" class="form-label">Marks (Class ${school.classLevel})</label>
            <input type="text" class="form-control" id="editSchoolMarks${index}" value="${school.marks || ''}" required>
        </div>
        <div class="mb-3">
            <label for="editSchoolYear${index}" class="form-label">Passing Year (Class ${school.classLevel})</label>
            <input type="text" class="form-control" id="editSchoolYear${index}" value="${school.passingYear || ''}" required>
        </div>
    `).join('')}
    <div class="mb-3">
        <label for="editCutoff" class="form-label">Cutoff Mark</label>
        <input type="text" class="form-control" id="editCutoff" value="${editingStudent.cutoff || ''}" required>
    </div>
    <h4 class="bold-text">Upload Certificates</h4>
            <div class="mb-3 bold-text">
                <label class="form-label">Aadhar Card:</label>
                <input type="file" class="form-control" name="aadharCard" accept=".pdf, .jpg, .png">
                <span id="aadharcard-error" class="error-message"></span>
                ${editingStudent.documents?.aadharCard ? `<p>Current: ${editingStudent.documents.aadharCard.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">Community Certificate:</label>
                <input type="file" class="form-control" name="communityCertificate" accept=".pdf, .jpg, .png">
                <span id="communitycertificate-error" class="error-message"></span>
                ${editingStudent.documents?.communityCertificate ? `<p>Current: ${editingStudent.documents.communityCertificate.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">10th Mark Sheet:</label>
                <input type="file" class="form-control" name="tenthMarkSheet" accept=".pdf, .jpg, .png">
                <span id="tenthmarksheet-error" class="error-message"></span>
                ${editingStudent.documents?.tenthMarkSheet ? `<p>Current: ${editingStudent.documents.tenthMarkSheet.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">11th Mark Sheet:</label>
                <input type="file" class="form-control" name="eleventhMarkSheet" accept=".pdf, .jpg, .png">
                <span id="eleventhmarksheet-error" class="error-message"></span>
                ${editingStudent.documents?.eleventhMarkSheet ? `<p>Current: ${editingStudent.documents.eleventhMarkSheet.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">12th Mark Sheet:</label>
                <input type="file" class="form-control" name="twelfthMarkSheet" accept=".pdf, .jpg, .png">
                <span id="twelfthmarksheet-error" class="error-message"></span>
                ${editingStudent.documents?.twelfthMarkSheet ? `<p>Current: ${editingStudent.documents.twelfthMarkSheet.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">Transfer Certificate:</label>
                <input type="file" class="form-control" name="transferCertificate" accept=".pdf, .jpg, .png">
                <span id="transfercertificate-error" class="error-message"></span>
                ${editingStudent.documents?.transferCertificate ? `<p>Current: ${editingStudent.documents.transferCertificate.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">Birth Certificate:</label>
                <input type="file" class="form-control" name="birthCertificate" accept=".pdf, .jpg, .png">
                <span id="birthcertificate-error" class="error-message"></span>
                ${editingStudent.documents?.birthCertificate ? `<p>Current: ${editingStudent.documents.birthCertificate.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">First Graduate Certificate:</label>
                <input type="file" class="form-control" name="firstCertificate" accept=".pdf, .jpg, .png" placeholder="IF YOUR FIRSTGRATUATE PLEASE UPLOAD CERTIFICATE">
                <span id="firstcertificate-error" class="error-message"></span>
                ${editingStudent.documents?.firstCertificate ? `<p>Current: ${editingStudent.documents.firstCertificate.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">Photo:</label>
                <input type="file" class="form-control" name="photo" accept=".pdf,.jpg, .png">
                <span id="photo-error" class="error-message"></span>
                ${editingStudent.documents?.photo ? `<p>Current: ${editingStudent.documents.photo.split('/').pop()}</p>` : ''}
            </div>
            <div class="mb-3 bold-text">
                <label class="form-label">Student Signature:</label>
                <input type="file" class="form-control" name="studentSignature" accept=".pdf,.jpg, .png">
                <span id="studentsignature-error" class="error-message"></span>
                ${editingStudent.documents?.studentSignature ? `<p>Current: ${editingStudent.documents.studentSignature.split('/').pop()}</p>` : ''}
            </div>
            <div class="form-row mt-3">
                <label for="admissionStatus" style="font-weight: bold; font-size: 1.2em;">Admission Status:</label>
                <div class="admission-status-options">
                    <label>
                        <input type="radio" id="admitted" name="admissionStatus[status]" value="Admitted" ${editingStudent.admissionStatus?.status === 'Admitted' ? 'checked' : ''}>
                        <span style="font-weight: bold; font-size: 1.1em;">Admitted</span>
                    </label>
                    <label>
                        <input type="radio" id="pending" name="admissionStatus[status]" value="Pending" ${editingStudent.admissionStatus?.status === 'Pending' ? 'checked' : ''}>
                        <span style="font-weight: bold; font-size: 1.1em;">Pending</span>
                    </label>
                    <label>
                        <input type="radio" id="notAdmitted" name="admissionStatus[status]" value="Rejected" ${editingStudent.admissionStatus?.status === 'Rejected' ? 'checked' : ''}>
                        <span style="font-weight: bold; font-size: 1.1em;">Not Admitted</span>
                    </label>
                </div>
            </div>
   
    
    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

    `;
    modalBody.innerHTML = modalBody.innerHTML;

    document.getElementById('editStudentForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);

        const updatedStudent = {
            ...editingStudent,
            name: document.getElementById('editName').value,
            department: document.getElementById('editDepartment').value,
            batch: document.getElementById('editBatch').value,
            dob: document.getElementById('editDob').value,
            gender: document.getElementById('editGender').value,
            bloodGroup: document.getElementById('editBloodGroup').value,
            aadharNo: document.getElementById('editAadharNo').value,
            mobileNo: document.getElementById('editMobileNo').value,
            email: document.getElementById('editEmail').value,
            nationality: document.getElementById('editNationality').value,
            religion: document.getElementById('editReligion').value,
            community: document.getElementById('editCommunity').value,
            motherTongue: document.getElementById('editMotherTongue').value,
            first: document.getElementById('editFirst').value === 'true',
            regular: document.getElementById('editRegular').value,
            address: {
                doorNo: document.getElementById('editDoorNo').value,
                street: document.getElementById('editStreet').value,
                villageCity: document.getElementById('editVillageCity').value,
                district: document.getElementById('editDistrict').value,
                state: document.getElementById('editState').value,
                pinCode: document.getElementById('editPinCode').value,
            },
            parents: {
                father: {
                    name: document.getElementById('editFatherName').value,
                    occupation: document.getElementById('editFatherOccupation').value,
                    mobile: document.getElementById('editFatherMobile').value,
                },
                mother: {
                    name: document.getElementById('editMotherName').value,
                    occupation: document.getElementById('editMotherOccupation').value,
                    mobile: document.getElementById('editMotherMobile').value,
                },
            },
            schoolDetails: editingStudent.schoolDetails.map((school, index) => ({
                ...school,
                name: document.getElementById(`editSchoolName${index}`).value,
                marks: document.getElementById(`editSchoolMarks${index}`).value,
                passingYear: document.getElementById(`editSchoolYear${index}`).value,
            })),
            cutoff: document.getElementById('editCutoff').value,
            admissionStatus: {
                status: document.querySelector('input[name="admissionStatus[status]"]:checked').value,
            }
            
        };
formData.append('updatedStudent', JSON.stringify(updatedStudent));
console.log(formData.get('updatedStudent'));

// Append certificate files
if (document.querySelector('input[name="aadharCard"]').files[0]) {
    formData.append('aadharCard', document.querySelector('input[name="aadharCard"]').files[0]);
}
if (document.querySelector('input[name="communityCertificate"]').files[0]) {
    formData.append('communityCertificate', document.querySelector('input[name="communityCertificate"]').files[0]);
}
if (document.querySelector('input[name="tenthMarkSheet"]').files[0]) {
    formData.append('tenthMarkSheet', document.querySelector('input[name="tenthMarkSheet"]').files[0]);
}
if (document.querySelector('input[name="eleventhMarkSheet"]').files[0]) {
    formData.append('eleventhMarkSheet', document.querySelector('input[name="eleventhMarkSheet"]').files[0]);
}
if (document.querySelector('input[name="twelfthMarkSheet"]').files[0]) {
    formData.append('twelfthMarkSheet', document.querySelector('input[name="twelfthMarkSheet"]').files[0]);
}
if (document.querySelector('input[name="transferCertificate"]').files[0]) {
    formData.append('transferCertificate', document.querySelector('input[name="transferCertificate"]').files[0]);
}
if (document.querySelector('input[name="birthCertificate"]').files[0]) {
    formData.append('birthCertificate', document.querySelector('input[name="birthCertificate"]').files[0]);
}
if (document.querySelector('input[name="firstCertificate"]').files[0]) {
    formData.append('firstCertificate', document.querySelector('input[name="firstCertificate"]').files[0]);
}
if (document.querySelector('input[name="photo"]').files[0]) {
    formData.append('photo', document.querySelector('input[name="photo"]').files[0]);
}
if (document.querySelector('input[name="studentSignature"]').files[0]) {
    formData.append('studentSignature', document.querySelector('input[name="studentSignature"]').files[0]);
}

        fetch(`/api/students/${editingStudent.registerNo}`, {
            method: 'PUT',
            body: formData,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedStudent),
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Update failed'); });
                }
                return response.json();
            })
            .then(() => {
                alert("Student details updated successfully!");
                loadStudents();
                const modal = bootstrap.Modal.getInstance(document.getElementById('studentDetailsModal'));
                modal.hide();
            })
            .catch(error => {
                console.error("Update error:", error);
                alert("Error updating student details: " + error.message);
            });
    });
}
function showStudentsByStatus(status) {
        currentAdmissionStatusFilter = status; // Set the admission status filter
        displayAllStudents(); // Show the student details page
    }
    let feesData = JSON.parse(localStorage.getItem("feesData")) || {
            tuition: [
                { branch: "B.Tech. (AIDS)", fg: "40000", nonFg: "65000", gq: "65000", mq: "65000" },
                { branch: "B.Tech. (IT)", fg: "30000", nonFg: "55000", gq: "55000", mq: "55000" },
                { branch: "B.E. (CSE)", fg: "30000", nonFg: "55000", gq: "55000", mq: "35000" },
                { branch: "B.E. (ECE)", fg: "20000", nonFg: "45000", gq: "45000", mq: "45000" },
                { branch: "B.Tech. (AGRI)", fg: "15000", nonFg: "40000", gq: "40000", mq: "40000" },
                { branch: "B.E. (MECH/MTS)", fg: "15000", nonFg: "40000", gq: "40000", mq: "40000" }
            ],
            hostel: [
                { branch: "B.Tech. (AIDS)", bcMbc: "50000", scSt: "35000" },
                { branch: "B.Tech. (IT) & B.E. (CSE)", bcMbc: "50000", scSt: "45000" },
                { branch: "B.E. (ECE)", bcMbc: "50000", scSt: "35000" },
                { branch: "B.E. (MECH/MTS) & B.Tech. (AGRI)", bcMbc: "50000", scSt: "30000" }
            ]
        };

        function generateTable() {
            let tableBody = document.getElementById("feeTableBody");
            tableBody.innerHTML = "";

            feesData.tuition.forEach(tuitionFee => {
                let hostelFee = feesData.hostel.find(h => h.branch.includes(tuitionFee.branch)) || { bcMbc: "N/A", scSt: "N/A" };
                let row = `
                    <tr>
                        <td>${tuitionFee.branch}</td>
                        <td contenteditable="false" class="fg">${tuitionFee.fg}</td>
                        <td contenteditable="false" class="nonFg">${tuitionFee.nonFg}</td>
                        <td contenteditable="false" class="gq">${tuitionFee.gq}</td>
                        <td contenteditable="false" class="mq">${tuitionFee.mq}</td>
                        <td contenteditable="false" class="bcMbc">${hostelFee.bcMbc}</td>
                        <td contenteditable="false" class="scSt">${hostelFee.scSt}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                            <button class="btn btn-success btn-sm save-btn" style="display:none;">Save</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            addEditFunctionality();
        }

        function addEditFunctionality() {
            document.querySelectorAll(".edit-btn").forEach(button => {
                button.addEventListener("click", function() {
                    let row = this.closest("tr");
                    row.querySelectorAll("td[contenteditable]").forEach(td => td.contentEditable = "true");
                    row.querySelector(".edit-btn").style.display = "none";
                    row.querySelector(".save-btn").style.display = "inline-block";
                });
            });

            document.querySelectorAll(".save-btn").forEach(button => {
                button.addEventListener("click", function() {
                    let row = this.closest("tr");
                    let branch = row.cells[0].innerText;

                    let tuitionEntry = feesData.tuition.find(t => t.branch === branch);
                    let hostelEntry = feesData.hostel.find(h => h.branch.includes(branch));

                    tuitionEntry.fg = row.querySelector(".fg").innerText.replace("", "");
                    tuitionEntry.nonFg = row.querySelector(".nonFg").innerText.replace("", "");
                    tuitionEntry.gq = row.querySelector(".gq").innerText.replace("", "");
                    tuitionEntry.mq = row.querySelector(".mq").innerText.replace("", "");

                    if (hostelEntry) {
                        hostelEntry.bcMbc = row.querySelector(".bcMbc").innerText.replace("", "");
                        hostelEntry.scSt = row.querySelector(".scSt").innerText.replace("", "");
                    }

                    localStorage.setItem("feesData", JSON.stringify(feesData));
                    row.querySelectorAll("td[contenteditable]").forEach(td => td.contentEditable = "false");
                    row.querySelector(".edit-btn").style.display = "inline-block";
                    row.querySelector(".save-btn").style.display = "none";
                    alert("Fees updated successfully!");
                });
            });
        }

        document.getElementById("feesStructureLink").addEventListener("click", function(event) {
            event.preventDefault();
            let tableContainer = document.getElementById("feeTableContainer");
            tableContainer.style.display = tableContainer.style.display === "none" ? "block" : "none";
            generateTable();
        });

        window.onload = generateTable;
        function saveToLocalStorage() {
    localStorage.setItem("feesData", JSON.stringify(feesData));
    alert("Fees updated successfully!");
}

</script>
</body>
</html>